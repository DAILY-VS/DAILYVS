{% load static %} {% block content %}
<div class="main-grid-container">
  <div id="main-grid-content" class="main-list-title">ğŸ—’ï¸ íˆ¬í‘œ ëª¨ìŒ ë¦¬ìŠ¤íŠ¸</div>
  <form action="{% url 'vote:main' %}" method="get">
    <select name="sort" class="option_select" id="selectSort" data-url="{% url 'vote:main' %}">
      <option value="popular" {% if sort == 'popular' %}selected{% endif %}>ì¸ê¸°ìˆœ</option>
      <option value="latest" {% if sort == 'latest' %}selected{% endif %}>ìµœì‹ ìˆœ</option>
      <option value="oldest" {% if sort == 'oldest' %}selected{% endif %}>ë“±ë¡ìˆœ</option>
    </select>    
  </form>
  <div class="main-grid-content">
    {% for page in page_obj %}
    <a class="main-grid-square" href="{% url 'vote:detail' page.id %}">
      <div class="grid-square-pic">
        <img src="../../../media/{{page.thumbnail}}" />
        <span class="grid-square-like-view">{{page.title}}</span>
      </div>
    </a>
    {% endfor %}
  </div>
  <div class="pagination-box">
    <div class="pagination">
      {% if page_obj.has_previous %}
      <a class="page-btn gray" href="?page={{ page_obj.previous_page_number }}">
        <img src="{% static 'img/icon/left_page.png' %}" style="width: 30px" />
      </a>
      {% endif %} {% for page_number in page_obj.paginator.page_range %}
      <a
        class="page-btn {% if page_number == page_obj.number %}red-pink{% endif %}"
        href="?page={{ page_number }}"
      >
        {{ page_number }}
      </a>
      {% endfor %} {% if page_obj.has_next %}
      <a class="page-btn gray" href="?page={{ page_obj.next_page_number }}">
        <img src="{% static 'img/icon/right_page.png' %}" style="width: 30px" />
      </a>
      {% endif %}
    </div>
  </div>
  {% endblock %}
</div>

<script>
document.addEventListener("DOMContentLoaded", function () {
  const pollList = document.querySelector(".main-grid-content");
  const pagination = document.querySelector(".pagination");
  const selectSort = document.querySelector("#selectSort");

  // ì„¸ì…˜ ìŠ¤í† ë¦¬ì§€ì— ì €ì¥ëœ ê°’ ë¶ˆëŸ¬ì˜¤ê¸°
  const savedSortValue = sessionStorage.getItem("selectedSort");
  if (savedSortValue) {
    selectSort.value = savedSortValue;
  }

  // í˜ì´ì§€ ë¡œë“œ ì‹œì—ë„ í•„í„° ê°’ì— ë”°ë¼ ë‚´ìš© ì—…ë°ì´íŠ¸
  const initialSortValue = selectSort.value;
  const initialPageUrl = `${selectSort.getAttribute('data-url')}?sort=${initialSortValue}`;
  updateContent(initialPageUrl);

  // í•„í„°ë§ ì˜µì…˜ ë³€ê²½ ì‹œ ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ ì¶”ê°€
  selectSort.addEventListener("change", function () {
    const sortValue = selectSort.value;
    const pageUrl = `${selectSort.getAttribute('data-url')}?sort=${sortValue}`;
    updateContent(pageUrl);
    
    // ì„ íƒí•œ ê°’ ì„¸ì…˜ ìŠ¤í† ë¦¬ì§€ì— ì €ì¥
    sessionStorage.setItem("selectedSort", sortValue);
  });

  // í˜ì´ì§€ ë‚´ìš© ì—…ë°ì´íŠ¸ í•¨ìˆ˜
  function updateContent(pageUrl) {
    fetch(pageUrl)
      .then((response) => response.text())
      .then((data) => {
        const parser = new DOMParser();
        const newDoc = parser.parseFromString(data, "text/html");

        pollList.innerHTML = newDoc.querySelector(".main-grid-content").innerHTML;
        pagination.innerHTML = newDoc.querySelector(".pagination").innerHTML;
      })
      .catch((error) => console.error("Error fetching page:", error));
  }

  pagination.addEventListener("click", function (event) {
    if (event.target.tagName === "A") {
      event.preventDefault();
      const pageUrl = event.target.getAttribute("href");
      updateContent(pageUrl);
    }
  });
});

</script>