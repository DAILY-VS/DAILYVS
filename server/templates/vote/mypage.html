{% extends 'vote/base.html' %} {% load static %} {% block content %}

<div>
  <div class="mypage-container">
    <p class="mypage-greeting">
      안녕하세요,
      <strong class="mypage-real-username">{{user.nickname}}</strong>&nbsp님!
    </p>
    <div class="mypage-prof-container">
      <img src="https://picsum.photos/100/100" alt="" />
      <div class="mypage-info-wrap">
        <div class="mypage-nickname-wrap">
          <span class="mypage-blue">{{user.nickname}}&nbsp</span>
          <span id="mypage-gray" class="mypage-blue">님</span>
          <a href="{% url 'vote:update' %}" class="mypage-revise-btn"
            >회원 수정</a
          >
        </div>
        <hr class="mypage-hr" />
        <div class="mypage-prof-detail">
          <div class="mypage-nickname-wrap">
            <span class="mypage-red">MBTI:</span>
            <span class="mypage-blue">&nbsp&nbsp{{user.mbti}}</span>
          </div>
          <div class="mypage-nickname-wrap">
            <span class="mypage-red">성별:</span>
            <span class="mypage-blue">&nbsp&nbsp{{user.gender}}</span>
          </div>
        </div>
      </div>
    </div>
    <span class="mypage-real-username">나의 VOTE LIST</span>
    <div class="mypage-voted-pagination">
        <div>
            {% for voted_poll in page_obj %}
              {% for uservote in uservotes %}
                {% if voted_poll.id == uservote.poll.id %}
                  <a href="{% url 'vote:calcstat' uservote.poll.id %}">{{ voted_poll }}</a>
                  <p>나의 선택: {{ uservote.choice.choice_text }}</p>
                {% endif %}
              {% endfor %}
            {% endfor %}
          </div>
      <div class="pagination">
        {% if page_obj.has_previous %}
        <a
          class="page-btn gray"
          href="?page={{ page_obj.previous_page_number }}"
        >
          <img
            src="{% static 'img/icon/left_page.png' %}"
            style="width: 30px"
          />
        </a>
        {% endif %} {% for page_number in page_obj.paginator.page_range %}
        <a
          class="page-btn {% if page_number == page_obj.number %}red-pink{% endif %}"
          href="?page={{ page_number }}"
        >
          {{ page_number }}
        </a>
        {% endfor %} {% if page_obj.has_next %}
        <a class="page-btn gray" href="?page={{ page_obj.next_page_number }}">
          <img
            src="{% static 'img/icon/right_page.png' %}"
            style="width: 30px"
          />
        </a>
        {% endif %}
      </div>
    </div>
    <div class="mypage-like-votelist">
      <span class="mypage-real-username">나의 VOTE Like LIST</span>
      <div class="mypage-like-column" id="polls-like-container">
        {% for poll_like in page_obj_polls_like %}
            {% if poll_like.id %}
                <a href="{% url 'vote:calcstat' poll_like.id %}">{{ poll_like }}</a>
            {% endif %}
        {% endfor %}
    </div>
      <button id="load-more-btn">더보기</button>
  </div>
  </div>
    {% if request.user == user %}
    <a href="{% url 'account:change_password' %}">비밀번호 변경</a>
    <a id="mypage-user-delete" href="{% url 'account:delete' %}">회원 탈퇴</a>
    {% endif %}
  </div>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script>
    $(document).ready(function () {
      $(".mypage-voted-pagination").on("click", ".page-btn", function (e) {
        e.preventDefault();

        var url = $(this).attr("href");

        $.ajax({
          type: "GET",
          url: url,
          success: function (data) {
            $(".mypage-voted-pagination").html(
              $(data).find(".mypage-voted-pagination").html()
            );
          },
          error: function () {
            alert("오류가 발생했습니다.");
          },
        });
      });
    });
  </script>
 <script>
  $(document).ready(function () {
   var nextPage = {{ page_obj_polls_like.next_page_number }}; // 다음 페이지 번호 초기값
   var isLoading = false;

   $("#load-more-btn").click(function () {
       if (isLoading) {
           return; // 이미 로딩 중인 경우 클릭을 무시
       }
       isLoading = true;
       
       $.ajax({
           type: "GET",
           url: window.location.href + "?page=" + nextPage,
           success: function (data) {
               var newPollsLike = $(data).find("#polls-like-container").html();
               if (newPollsLike.trim() === "") {
                   $("#load-more-btn").hide();
               } else {
                   $("#polls-like-container").append(newPollsLike);
                   nextPage++;
               }
           },
           error: function () {
               alert("더보기를 불러오는 도중 오류가 발생했습니다.");
           },
           complete: function () {
               isLoading = false; // 로딩 완료 후 상태 변경
           }
       });
   });
});

</script>

</div>
{% endblock %}
