{% load static %} {% block content %}

    <div>
    <!-- 댓글 작성 폼 -->
    <form id="commentForm" method="POST">
        {% csrf_token %}
        {{ comment_form.as_p }}
        <button type="submit">댓글 작성</button>
    </form>
</div>

<!-- 댓글 목록 표시 -->
<div id="comment_list">
    {% for comment in comments %}
    <div id="comment_{{ comment.id }}">
        <!-- 댓글 내용 및 정보 표시 -->
        <strong>{{ comment.user_info.nickname }}</strong>
        <strong>{{ comment.user_info.mbti }}</strong>
        <strong>{{ comment.user_info.gender }}</strong>
        <span>{{ comment.created_at }}</span>
        <div>{{ comment.content }}</div>
        <div>
            <a class="btnDelete" data-comment-id="{{ comment.id }}">댓글 삭제</a>
        </div>
        <hr>
    </div>
    {% endfor %}
</div>

<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<script>
document.querySelector("#commentForm").addEventListener("submit", function(e) {
    e.preventDefault();

    let formData = new FormData(this);
    let pollId = "{{ poll.id }}";

    axios({
        method: 'post',
        url: `/${pollId}/reply/`,
        headers: {
            "X-CSRFToken": getCookie("csrftoken")
        },
        data: formData
    })
    .then(response => {
        let data = response.data.comment;
        addCommentToDOM(data); // 댓글을 DOM에 추가
        document.querySelector(".replyContent").value = ''; // 입력창 비우기
    })
    .catch(error => {
        console.error("댓글 작성 중 오류가 발생했습니다.", error);
    });
});

// 댓글을 DOM에 추가하는 함수
function addCommentToDOM(comment) {
    let commentList = document.getElementById("comment_list");
    
    let newCommentDiv = document.createElement("div");
    newCommentDiv.id = `comment_${comment.comment_id}`;
    newCommentDiv.innerHTML = `
        <strong>${comment.nickname}</strong>
        <span style="float:right">${comment.created_at}</span>
        <div>${comment.content}</div>
        <div>
            <a class="btnDelete" data-comment-id="${comment.comment_id}">댓글 삭제</a>
        </div>
        <hr>
    `;
    
    commentList.appendChild(newCommentDiv);
}

//댓글 삭제
document.addEventListener("DOMContentLoaded", function() {
    const deleteButtons = document.querySelectorAll(".btnDelete");
    
    deleteButtons.forEach(button => {
        button.addEventListener("click", function() {
            const commentId = this.getAttribute("data-comment-id");
            let pollId = "{{ poll.id }}";
            axios({
                method: "post",
                url: `/${pollId}/reply/delete/`,  // 적절한 URL로 수정
                headers: {
                    "X-CSRFToken": getCookie("csrftoken") // CSRF 토큰 추가
                },
                data: {
                    comment_id: commentId
                }
            })
            .then(response => {
                if (response.data.success) {
                    // 성공적으로 삭제되면 해당 댓글 행 삭제
                    const deletedRow = document.querySelector(`#comment_${commentId}`);
                    if (deletedRow) {
                        deletedRow.remove();
                    }
                } else {
                    console.error(response.data.error);
                }
            })
            .catch(error => {
                console.error("댓글 삭제 중 오류가 발생했습니다.", error);
            });
        });
    });
});


// CSRF 토큰을 가져오는 함수
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== "") {
        const cookies = document.cookie.split(";");
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === name + "=") {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
</script>

{% endblock %}
