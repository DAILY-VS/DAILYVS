<div>
    {% csrf_token %}
    <div>
        <textarea id="content_id" rows="3" placeholder="댓글을 입력해주세요."></textarea>
    </div>
    <div>
        <button id="comment_write" class="btn btn-sm">댓글달기</button>
    </div>
</div>
<hr>
    <div id="more_comment">
        {% if comments %}
            {% for comment in comments %}
            <div id='{{ comment.id }}'>
                {% if comment.deleted %}
                <span>삭제된 댓글입니다.</span><hr>
                {% else %}
                    <span>닉네임: {{ comment.user_info.nickname }}, 
                          MBTI: {{ comment.user_info.mbti}}, 
                          gender: {{ comment.user_info.gender}}
                    </span>
                    <br>
                    <span>{{ comment.created_at }}</span>
                    <div>
                        <div>{{ comment.content }}</div>
                        <div>
                            <a onclick="commentDelete('{{comment.id}}');">댓글삭제</a>
                        </div>
                    </div>
                    <hr>
                {% endif %}
            </div>
            <div class='{{ comment.id }}'></div>
            {% endfor %}
        {% endif %}
        <input type="hidden" id="comment_writer" value={{request.user}}>
        <div id="comment_list"></div>
    </div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
    $(document).ready(function () {
        $('#comment_write').click(function () {
            var content= $("#content_id").val();
            var writer= $("#comment_writer").val();
            $.ajax({
                type: "POST",
                url: "{% url 'vote:comment_write' poll.id %}",
                dataType: "json",
                data: {
                    // 'user_info': user_info,
                    'content': content,
                    'csrfmiddlewaretoken': '{{csrf_token}}',
                },
                success: function (response) {

                    $('#comment_list').append(
                        '<div><div id='+response.mbti+'><strong>'+response.nickname+'&nbsp;<span style="color:gray";>'+response.self_comment+'</span></strong>'+
                        '<span style="float:right; color:#d14040f2;">'+response.created_at+'</span>'+
                        '<div><div style="white-space:pre-wrap; text-align:left;">'+response.content+'</div><div style="text-align:right; margin:-20px 0px -10px 0;"><a style="color: #d14040f2;" onclick="createReplyArea('+response.comment_id+');">답글달기</a>&nbsp;&middot;&nbsp;<a style="color: #d14040f2;" onclick="commentDelete('+response.comment_id+');">댓글삭제</a></div></div><hr></div><div class='+response.comment_id+'></div>'
                    );
                    $('#content_id').val("");
                },
                error: function () {
                    if ($('#content_id').val()=="") {
                        alert('댓글을 입력해주세요.');
                    }
                },
            })
        });
    });

</script>
<script>
    function commentDelete(value) {
        var comment_id = value;
        var delete_warning = confirm('댓글을 삭제하시겠습니까?');
        if (delete_warning == true) {
            $.ajax({
                type: "POST",
                url: "{% url 'vote:comment_delete' poll.id %}",
                dataType: "json",
                data: {
                    'comment_id': comment_id,
                    'csrfmiddlewaretoken': '{{csrf_token}}',
                },
                success: function (response) {
                    $('#' + response.comment_id).remove(); // 엘리먼트제거
                },
                error: function () {
                    alert('본인 댓글이 아닙니다.');
                },
            });
        }
    }
</script> 

