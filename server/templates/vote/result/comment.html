{% load static %} {% block content %} {% csrf_token %}
<div class="comment-container">
  <div class="comment-category-title">댓글</div>
  <div class="comment-input-container">
    <div class="coment-user-info">
      <div class="comment-user-name">{{ user.nickname }}</div>
      <div class="user-sub-info">{{ user.mbti }}</div>
      <div class="user-sub-info">{{ user.gender }}</div>
    </div>
    <textarea
      class="replyContent"
      id="content_id"
      placeholder="댓글을 입력해주세요."
    ></textarea>
    <button id="comment_write" class="btnReply">댓글달기</button>
  </div>
  <hr />
  <div class="replyTable">
    <div class="replyTody">
      {% for comment in comments reversed%}
      {% if comment.parent_comment is null %}
      <div class="replyTr{{ comment.id }}">
        <div class="stored-comment-container">
            <div class="comment-top-section">
                <div class="comment-nickname">{{ comment.user_info.nickname }}</div>
                <div class="comment-sub-info">
                    <div class="user-sub-info">{{ comment.user_info.mbti}}</div>
                    <div class="user-sub-info">{{ comment.user_info.gender}}</div>
                    <div class="user-sub-info choice-color">
                      
                      {% if user.is_authenticated %}
                            {% if user_votes %}
                                {% for user_vote in user_votes %}
                                    {% if user_vote.poll == comment.poll %}
                                        {{ user_vote.choice.choice_text }}
                                    {% endif %}
                                {% endfor %}
                            {% else %}
                                로그인 후 확인 가능합니다.
                            {% endif %}
                        {% else %}
                            로그인 후 확인 가능합니다.
                        {% endif %}
                    
                    </div>
                    <div class="user-sub-info time-line">{{ comment.created_at|timesince }} 전</div>
                </div>
            </div>
            <div class="comment-content-delete">
                <div class="stored-comment-content">{{ comment.content }}</div>
                {% if user.is_authenticated and user.nickname == comment.user_info.nickname %}
                    <img
                    src="{% static 'img/icon/x.png' %}"
                    type="button"
                    value="x"
                    onclick="replyDelete({{ comment.id }})"
                    />
                {% endif %}
            </div>
            <button id="reply-toggle-btn-{{ comment.id }}" class="reply-toggle-btn" data-comment-id="{{ comment.id }}">답글 <span id="nestedCount{{ comment.id }}" data-comment-id="{{ comment.id }}"></span></button>
            </div>
        </div>
        <div class="every-reply-container">
              <div class="nested-reply-container" data-parent-id="{{ comment.id }}" style="display:none">
                  <!-- 대댓글 표시 영역 -->
                  <div class="nested-replyTody">
                    {% for child_comment in comments reversed %}
                      {% if child_comment.parent_comment_id == comment.id %}
                        <div class="nested-replyTr{{ child_comment.id }}">
                          <div class="nested-row">
                            <div><img src="{% static 'img/icon/reply.png' %}" style="width:25px;" /></div>
                            <div class="comment-nickname">{{ child_comment.user_info.nickname }}</div>
                            <div class="comment-sub-info">
                              <div class="user-sub-info">{{ child_comment.user_info.mbti}}</div>
                              <div class="user-sub-info">{{ child_comment.user_info.gender}}</div>
                              <div class="user-sub-info choice-color">                        
                                {% if user.is_authenticated %}
                                  {% if user_votes %}
                                    {% for user_vote in user_votes %}
                                      {% if user_vote.poll == child_comment.poll %}
                                        {{ user_vote.choice.choice_text }}
                                      {% endif %}
                                    {% endfor %}
                                  {% else %}
                                    로그인 후 확인 가능합니다.
                                  {% endif %}
                                {% else %}
                                  로그인 후 확인 가능합니다.
                                {% endif %}
                              </div>
                            </div>
                            <div class="user-sub-info time-line">{{ child_comment.created_at|timesince }} 전</div>
                          </div>
                          
                          <div class="comment-content-delete">
                            <div class="stored-comment-content">{{ child_comment.content }}</div>
                            {% if user.is_authenticated and user.nickname == child_comment.user_info.nickname %}
                              <img
                                src="{% static 'img/icon/x.png' %}"
                                type="button"
                                value="x"
                                onclick="nestedReplyDelete({{ child_comment.id }})"
                              />
                            {% endif %}
                          </div>
                          
                        </div>
                      {% endif %}
                    {% endfor %}
                  </div>
                  <!-- 대댓글 작성 영역 -->
                  {% if not comment.parent_comment %}
                  <div class="nested-reply-input-container">
                    <textarea
                      class="nested-replyContent"
                      id="nested_content_id_{{ comment.id }}"
                      placeholder="대댓글을 입력해주세요."
                    ></textarea>
                    <button class="btnNestedReply" data-comment-id="{{ comment.id }}">등록</button>
                  </div>        
                  {% endif %}
                </div>
              {% endif %}
              {% endfor %}
            </div>
          </div>
      </div>
  </div>
</div>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="{% static 'js/comment.js' %}"></script>
<script>

$(document).ready(function () {
    //댓글 달기
  $("#comment_write").click(function () {
    var content = $(".replyContent").val();

    // 로그인 여부 확인
    var isAuthenticated = "{{ user.is_authenticated }}";
    if (isAuthenticated === "True") {
      $.ajax({
        type: "POST",
        url: "{% url 'vote:comment_write' poll.id %}",
        dataType: "json",
        data: {
          content: content,
          csrfmiddlewaretoken: "{{ csrf_token }}",
        },
        success: function (response) {
          // 새로운 댓글 생성
          var newComment =
            '<div class="replyTr' +
            response.comment_id +
            '">' +
            '<div class="stored-comment-container">' +
            '<div class="comment-top-section">' +
            '<div class="comment-nickname">' + response.nickname + '</div>' +
            '<div class="comment-sub-info">' +
            '<div class="user-sub-info">' + response.mbti + '</div>' +
            '<div class="user-sub-info">' + response.gender + '</div>' +
            '<div class="user-sub-info choice-color">' + response.chioce + '</div>' +
            '<div class="user-sub-info time-line">' +  response.created_at +'</div>' +
            '</div>' +
            '</div>' +
            '<div class="comment-content-delete">' +
            '<div class="stored-comment-content">' + response.content + '</div>';
          
          // 로그인한 사용자와 댓글 작성자가 동일한 경우에만 삭제 버튼 추가
          if ("{{ user.is_authenticated }}" === "True" && "{{ user.nickname }}" === response.nickname) {
            newComment +=
              '<img src="{% static 'img/icon/x.png' %}" type="button" value="x" onclick="replyDelete(' +
              response.comment_id +
              ')" />';
          }
          
          newComment +=
            '</div>' +
            '<div class="nested-reply-input-container">' +
            '<textarea class="nested-replyContent" id="nested_content_id_' + response.comment_id + '" placeholder="대댓글을 입력해주세요."></textarea>' +
            '<button class="btnNestedReply" data-comment-id="' + response.comment_id + '">등록</button>' +
            '</div>' +
            '</div>' +
            '</div>';
          
          $(".replyTody").prepend(newComment);
          $(".replyContent").val(""); // 입력창 비우기
        },
        error: function () {
          if ($(".replyContent").val() == "") {
            alert("댓글을 입력해주세요.");
          } else {
            alert("오류가 발생했습니다.");
          }
        },
      });
    } else {
      if (confirm("로그인이 필요합니다. 로그인 페이지로 이동하시겠습니까?")) {
        var loginUrl = "/account/login/";
        window.location.href = loginUrl;  // 로그인 페이지 URL로 이동
    }
    }
  });



  // 대댓글 달기
  $(document).on("click", ".btnNestedReply", function () {
    var comment_id = $(this).data("comment-id");
    var nestedContent = $("#nested_content_id_" + comment_id).val();
    var isAuthenticated = "{{ user.is_authenticated }}";

    if (isAuthenticated === "True") {
      $.ajax({
        type: "POST",
        url: "{% url 'vote:comment_write' poll.id %}",
        dataType: "json",
        cache: false,
        data: {
          content: nestedContent,
          parent_comment_id: comment_id, // 대댓글의 부모 댓글 ID 전달
          csrfmiddlewaretoken: "{{ csrf_token }}",
        },
        success: function (response) {
          // 새로운 대댓글 생성
          var newNestedComment =
            '<div class="nested-replyTr' + response.comment_id + '">' +
            '<div class="nested-row">' +
            '<img src="{% static "img/icon/reply.png" %}" style="width:25px; height: 25px;" />' +
            '<div class="nested-stored-comment-container">' +
            '<div class="nested-comment-top-section">' +
            '<div class="comment-nickname">' + response.nickname + '</div>' +
            '<div class="comment-sub-info">' +
            '<div class="user-sub-info">' + response.mbti + '</div>' +
            '<div class="user-sub-info">' + response.gender + '</div>' +
            '<div class="user-sub-info choice-color">' + response.chioce + '</div>' +
            '<div class="user-sub-info time-line">'+ '방금 전' + '</div>'  +
            '</div>' +
            '</div>' +
            '<div class="comment-content-delete">' +
            '<div class="stored-comment-content">' + response.content + '</div>' +
            '<img src="{% static "img/icon/x.png" %}" type="button" value="x" onclick="nestedReplyDelete(' + response.comment_id + ')" />' +
            '</div>' +
            '</div>' +
            '</div>' +
            '</div>';

          updateNestedCount(comment_id);
          // 선택한 부모 댓글 바로 하단에 추가
          $(".nested-reply-container[data-parent-id='" + comment_id + "']").prepend(newNestedComment);
          $("#nested_content_id_" + comment_id).val(""); // 입력창 비우기
        },
        error: function () {
          if ($("#nested_content_id_" + comment_id).val() == "") {
            alert("대댓글을 입력해주세요.");
          } else {
            alert("오류가 발생했습니다.");
          }
        },
      });
    } else {
      if (confirm("로그인이 필요합니다. 로그인 페이지로 이동하시겠습니까?")) {
        var loginUrl = "/account/login/";
        window.location.href = loginUrl; // 로그인 페이지 URL로 이동
      }
    }
  });
});

   // 댓글 삭제
   function replyDelete(value) {
    var comment_id = value;
    var delete_warning = confirm("댓글을 삭제하시겠습니까?");

    if (delete_warning == true) {
      // 로그인 여부 확인
      var isAuthenticated = "{{ user.is_authenticated }}";
      if (isAuthenticated === "True") {
        $.ajax({
          type: "POST",
          url: "{% url 'vote:comment_delete' poll.id %}",
          dataType: "json",
          data: {
            comment_id: comment_id,
            csrfmiddlewaretoken: "{{csrf_token}}",
          },
          success: function (response) {
            if (response.success) {
              $("#" + response.comment_id).remove();
              var replyTr = document.querySelector(
                `.replyTr${response.comment_id}`
              );
              if (replyTr) {
                console.log(replyTr);
                replyTr.remove();
              }
            } else {
              alert(response.error);
            }
          },
          error: function () {
            alert("오류가 발생했습니다.");
          },
        });
      } else {
        alert("로그인을 해주세요");
      }}}

    function nestedReplyDelete(value) {
    var comment_id = value;
    var delete_warning = confirm("대댓글을 삭제하시겠습니까?");

    if (delete_warning == true) {
      var isAuthenticated = "{{ user.is_authenticated }}";
      if (isAuthenticated === "True") {
        $.ajax({
          type: "POST",
          url: "{% url 'vote:comment_delete' poll.id %}",
          dataType: "json",
          data: {
            comment_id: comment_id,
            csrfmiddlewaretoken: "{{ csrf_token }}",
          },
          success: function (response) {
            if (response.success) {
              $("#" + response.comment_id).remove();
              var nestedReplyTr = document.querySelector(
                `.nested-replyTr${response.comment_id}`
              );
              if (nestedReplyTr) {
                console.log(nestedReplyTr);
                nestedReplyTr.remove();
              }
            } else {
              alert(response.error);
            }
          },
          error: function () {
            alert("오류가 발생했습니다.");
          },
        });
      } else {
        alert("로그인을 해주세요");
      }
    }
  };

</script>

{% endblock %}
